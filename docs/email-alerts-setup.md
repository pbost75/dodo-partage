# üìß Syst√®me d'Alertes Email - DodoPartage

Ce guide explique le syst√®me d'alertes email complet pour DodoPartage, utilisant le **backend centralis√© Railway** avec **Airtable** et **Resend** pour une architecture coh√©rente avec l'√©cosyst√®me Dodomove.

## üèóÔ∏è Architecture Centralis√©e

```
Frontend DodoPartage (Next.js)
    ‚Üì (API calls via HTTPS)
Backend Centralis√© Dodomove (Railway)
    ‚Üì (stockage + emails)
Airtable + Resend
```

**Avantages de cette approche :**
- üîí **S√©curit√©** : Cl√©s API c√¥t√© serveur uniquement
- üé® **Coh√©rence** : Emails avec le design Dodomove existant
- üîß **Maintenance** : Une seule configuration √† g√©rer
- üìà **√âvolutivit√©** : Architecture centralis√©e

## üéØ Fonctionnalit√©s Compl√®tes

Le syst√®me d'alertes email permet aux utilisateurs de :
- **Cr√©er des alertes** pour des trajets sp√©cifiques (d√©part ‚Üí arriv√©e)
- **D√©finir un volume minimum** requis
- **Choisir le type** d'alerte ("offer" ou "request")
- **Recevoir des emails** via Resend avec design coh√©rent Dodomove
- **Se d√©sabonner facilement** via un lien dans l'email
- **Validation automatique** des donn√©es avant cr√©ation

## üìã Configuration Airtable D√©taill√©e

### 1. Table "DodoPartage - Email Alert"

**Informations de votre table :**
- **Base ID** : `appyuDiWXUzpy9DTT`
- **Table ID** : `tblVuVneCZTot07sB`
- **View ID** : `viw7ys2GOOVuk0qTD`

**Structure des colonnes :**

| Nom de la colonne | Type | Options | Description | Obligatoire |
|-------------------|------|---------|-------------|-------------|
| `type` | Single select | "offer", "request" | Type d'alerte | ‚úÖ |
| `departure` | Single line text | - | Lieu de d√©part | ‚úÖ |
| `arrival` | Single line text | - | Lieu d'arriv√©e | ‚úÖ |
| `volume_min` | Number | - | Volume minimum en m¬≥ | ‚úÖ |
| `email` | Email | - | Email pour recevoir les alertes | ‚úÖ |
| `status` | Single select | "Active", "Inactive" | Statut de l'alerte | ‚úÖ |
| `created_at` | Date with time | - | Date de cr√©ation | ‚úÖ |
| `unsubscribe_token` | Single line text | - | Token de d√©sabonnement unique | ‚úÖ |

### 2. Mapping des Variables

**Frontend ‚Üí Backend ‚Üí Airtable :**
```javascript
// Donn√©es envoy√©es par le frontend
{
  type: "offer" | "request",
  departure: "France",
  arrival: "Martinique", 
  volume_min: 5,
  email: "user@example.com"
}

// Stockage dans Airtable (ajouts automatiques)
{
  type: "offer",
  departure: "France", 
  arrival: "Martinique",
  volume_min: 5,
  email: "user@example.com",
  status: "Active", // Par d√©faut
  created_at: "2024-01-15T10:30:00.000Z", // Auto
  unsubscribe_token: "unique-token-123" // G√©n√©r√©
}
```

## ‚öôÔ∏è Configuration Technique

### 1. Variables d'environnement Frontend

**Fichier `.env.local` :**
```bash
# Configuration du backend centralis√©
NEXT_PUBLIC_BACKEND_URL=https://web-production-7b738.up.railway.app
```

### 2. Configuration Backend (Railway)

**Variables d√©j√† configur√©es sur Railway :**
```bash
AIRTABLE_API_KEY=pat_xxxxxxxxxx
AIRTABLE_BASE_ID=appyuDiWXUzpy9DTT
AIRTABLE_EMAIL_ALERTS_TABLE_ID=tblVuVneCZTot07sB
RESEND_API_KEY=re_xxxxxxxxxx
```

## üîå APIs D√©taill√©es

### 1. Cr√©er une Alerte - `POST /api/create-alert`

**Donn√©es requises :**
```json
{
  "type": "offer" | "request",
  "departure": "string (obligatoire)",
  "arrival": "string (obligatoire)", 
  "volume_min": "number (obligatoire, > 0)",
  "email": "string (format email valide)"
}
```

**Validation automatique :**
- ‚úÖ Format email valide
- ‚úÖ Volume minimum > 0
- ‚úÖ Type dans ["offer", "request"]
- ‚úÖ Departure et arrival non vides

**Exemple de r√©ponse succ√®s :**
```json
{
  "success": true,
  "message": "Alerte email cr√©√©e avec succ√®s !",
  "data": {
    "alertId": "rec123456789",
    "email": "user@example.com",
    "type": "request",
    "departure": "France",
    "arrival": "Martinique",
    "volume_min": 5,
    "confirmationEmailSent": true,
    "unsubscribeToken": "unique-token-abc123"
  },
  "backend": {
    "used": "centralized",
    "url": "https://web-production-7b738.up.railway.app"
  }
}
```

**Exemple de r√©ponse erreur :**
```json
{
  "success": false,
  "error": "Email invalide",
  "details": {
    "field": "email",
    "value": "invalid-email",
    "expected": "Format email valide"
  }
}
```

### 2. Test de Connexion - `GET /api/test-email-alerts`

**R√©ponse :**
```json
{
  "success": true,
  "message": "Connexion aux alertes email r√©ussie via le backend centralis√© !",
  "backend": {
    "url": "https://web-production-7b738.up.railway.app",
    "accessible": true,
    "config": {
      "airtable": "configured",
      "resend": "configured"
    }
  },
  "timestamp": "2024-01-15T10:30:00.000Z"
}
```

### 3. D√©sabonnement - `GET /api/unsubscribe-alert?token=XXXXX`

**Param√®tres :**
- `token` : Token de d√©sabonnement unique

**R√©ponse :** Page HTML de confirmation avec design Dodomove

## üìÅ Fichiers Impl√©ment√©s

### Routes API Frontend (‚úÖ Cr√©√©es)
```
src/app/api/
‚îú‚îÄ‚îÄ create-alert/route.ts      # Cr√©ation d'alertes via backend
‚îú‚îÄ‚îÄ test-email-alerts/route.ts # Test de connexion
‚îî‚îÄ‚îÄ unsubscribe-alert/route.ts # D√©sabonnement avec page HTML
```

### Scripts et Configuration (‚úÖ Cr√©√©s)
```
scripts/
‚îî‚îÄ‚îÄ test-email-alerts.js       # Script de test complet

package.json                   # Script "test:email-alerts" ajout√©
```

### Routes Backend (‚è≥ √Ä impl√©menter sur Railway)
```
Backend Railway - Routes n√©cessaires :
‚îú‚îÄ‚îÄ POST /api/partage/create-alert      # Cr√©ation d'alertes
‚îú‚îÄ‚îÄ GET /api/partage/test-alerts        # Test de configuration  
‚îî‚îÄ‚îÄ POST /api/partage/unsubscribe-alert # D√©sabonnement
```

## üß™ Tests et Validation

### 1. Test Automatique Complet

```bash
# D√©marrez le serveur de d√©veloppement
npm run dev

# Lancez le script de test complet
npm run test:email-alerts
```

**Le script teste :**
- ‚úÖ Connexion au backend centralis√©
- ‚úÖ Cr√©ation d'alerte avec donn√©es valides
- ‚úÖ Validation des erreurs (email invalide, volume n√©gatif)
- ‚úÖ Test de d√©sabonnement
- ‚úÖ V√©rification des r√©ponses JSON

### 2. Tests Manuels

**Test de connexion :**
```
http://localhost:3000/api/test-email-alerts
```

**Test de cr√©ation d'alerte :**
```bash
curl -X POST http://localhost:3000/api/create-alert \
  -H "Content-Type: application/json" \
  -d '{
    "type": "request",
    "departure": "France",
    "arrival": "Martinique",
    "volume_min": 5,
    "email": "test@example.com"
  }'
```

**Test de d√©sabonnement :**
```
http://localhost:3000/api/unsubscribe-alert?token=test-token
```

## üöÄ Int√©gration Frontend

### 1. Formulaire de Cr√©ation d'Alerte

```tsx
const handleCreateAlert = async (formData: {
  type: 'offer' | 'request';
  departure: string;
  arrival: string;
  volume_min: number;
  email: string;
}) => {
  try {
    const response = await fetch('/api/create-alert', {
      method: 'POST',
      headers: { 'Content-Type': 'application/json' },
      body: JSON.stringify(formData)
    });
    
    const result = await response.json();
    
    if (result.success) {
      // ‚úÖ Succ√®s - Afficher confirmation
      console.log('Alerte cr√©√©e !', result.data);
      // Rediriger vers page de confirmation
      // Afficher toast de succ√®s
    } else {
      // ‚ùå Erreur - Afficher message d'erreur
      console.error('Erreur:', result.error);
      // Afficher message d'erreur √† l'utilisateur
    }
  } catch (error) {
    console.error('Erreur r√©seau:', error);
    // G√©rer erreur de connexion
  }
};
```

### 2. Composant Formulaire Complet

```tsx
import { useState } from 'react';

export default function AlertForm() {
  const [formData, setFormData] = useState({
    type: 'request' as 'offer' | 'request',
    departure: '',
    arrival: '',
    volume_min: 1,
    email: ''
  });
  
  const [loading, setLoading] = useState(false);
  const [message, setMessage] = useState('');

  const handleSubmit = async (e: React.FormEvent) => {
    e.preventDefault();
    setLoading(true);
    
    try {
      const response = await fetch('/api/create-alert', {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify(formData)
      });
      
      const result = await response.json();
      
      if (result.success) {
        setMessage('‚úÖ Alerte cr√©√©e avec succ√®s !');
        // Reset form
        setFormData({
          type: 'request',
          departure: '',
          arrival: '',
          volume_min: 1,
          email: ''
        });
      } else {
        setMessage(`‚ùå Erreur: ${result.error}`);
      }
    } catch (error) {
      setMessage('‚ùå Erreur de connexion');
    } finally {
      setLoading(false);
    }
  };

  return (
    <form onSubmit={handleSubmit} className="space-y-4">
      {/* Champs du formulaire */}
      <div>
        <label>Type d'alerte :</label>
        <select 
          value={formData.type}
          onChange={(e) => setFormData({...formData, type: e.target.value as 'offer' | 'request'})}
        >
          <option value="request">Je cherche (demande)</option>
          <option value="offer">Je propose (offre)</option>
        </select>
      </div>
      
      {/* Autres champs... */}
      
      <button type="submit" disabled={loading}>
        {loading ? 'Cr√©ation...' : 'Cr√©er l\'alerte'}
      </button>
      
      {message && <p>{message}</p>}
    </form>
  );
}
```

## üîß D√©pannage D√©taill√©

### Erreurs Courantes et Solutions

**1. "Configuration backend manquante"**
```bash
# V√©rifiez votre .env.local
cat .env.local | grep NEXT_PUBLIC_BACKEND_URL

# Doit contenir :
NEXT_PUBLIC_BACKEND_URL=https://web-production-7b738.up.railway.app
```

**2. "Backend error: 404"**
- ‚ùå **Cause** : Routes backend pas encore impl√©ment√©es
- ‚úÖ **Solution** : Impl√©menter les routes sur Railway

**3. "Backend error: 500"**
- ‚ùå **Cause** : Erreur c√¥t√© backend centralis√©
- ‚úÖ **Solution** : V√©rifier les logs Railway

**4. "Email invalide"**
- ‚ùå **Cause** : Format email incorrect
- ‚úÖ **Solution** : Valider c√¥t√© frontend avant envoi

**5. "Volume minimum invalide"**
- ‚ùå **Cause** : Volume ‚â§ 0
- ‚úÖ **Solution** : Valider volume > 0

### Logs de D√©bogage

**Frontend (Console) :**
```javascript
// Logs automatiques dans les routes API
console.log('üìß Cr√©ation d\'alerte demand√©e');
console.log('üì§ Envoi vers backend centralis√©');
console.log('‚úÖ Alerte cr√©√©e avec succ√®s');
console.log('‚ùå Erreur:', error);
```

**Backend (Railway) :**
```javascript
// Logs √† ajouter c√¥t√© backend
console.log('üìß R√©ception demande cr√©ation alerte');
console.log('üíæ Sauvegarde dans Airtable');
console.log('üì® Envoi email de confirmation');
```

## üìä Monitoring et Analytics

### Vues Airtable Recommand√©es

**1. Vue "Alertes Actives"**
- Filtre : `status = "Active"`
- Tri : `created_at` d√©croissant

**2. Vue "Par Trajet"**
- Group√© par : `departure`
- Puis group√© par : `arrival`

**3. Vue "Statistiques"**
- Champs calcul√©s pour m√©triques

### M√©triques √† Surveiller

- üìà **Nombre d'alertes cr√©√©es par jour**
- üìâ **Taux de d√©sabonnement**
- üó∫Ô∏è **Trajets les plus demand√©s**
- üì¶ **Volume moyen des alertes**
- üìß **Taux d'ouverture des emails**

## üéâ Prochaines √âtapes

### C√¥t√© Backend (Railway) - √Ä Impl√©menter

**Routes √† ajouter dans dodomove-backend :**

```javascript
// 1. Cr√©ation d'alerte
app.post('/api/partage/create-alert', async (req, res) => {
  // Validation des donn√©es
  // G√©n√©ration token de d√©sabonnement
  // Sauvegarde dans Airtable
  // Envoi email de confirmation via Resend
});

// 2. Test de configuration
app.get('/api/partage/test-alerts', async (req, res) => {
  // V√©rification connexion Airtable
  // V√©rification connexion Resend
  // Retour statut configuration
});

// 3. D√©sabonnement
app.post('/api/partage/unsubscribe-alert', async (req, res) => {
  // Recherche par token
  // Mise √† jour status = "Inactive"
  // Confirmation d√©sabonnement
});
```

### C√¥t√© Frontend - Pr√™t ‚úÖ

Une fois les routes backend ajout√©es :

1. **‚úÖ Syst√®me complet fonctionnel**
2. **‚úÖ Tests automatis√©s passent**
3. **‚úÖ Interface utilisateur int√©grable**
4. **‚úÖ Gestion d'erreurs compl√®te**

### Fonctionnalit√©s Avanc√©es (Futures)

- üîî **Notifications push** en plus des emails
- üìÖ **Alertes avec dates d'expiration**
- üí∞ **Filtres par prix maximum**
- üì± **Interface mobile optimis√©e**
- üìä **Dashboard utilisateur** pour g√©rer ses alertes

## ‚úÖ R√©capitulatif Final

**‚úÖ C√¥t√© Frontend (Termin√©) :**
- Routes API cr√©√©es et test√©es
- Validation des donn√©es
- Gestion d'erreurs compl√®te
- Scripts de test automatis√©s
- Documentation compl√®te

**‚è≥ C√¥t√© Backend (√Ä faire) :**
- Impl√©menter 3 routes sur Railway
- Tester l'int√©gration compl√®te
- Configurer l'envoi d'emails automatique

**üéØ R√©sultat Final :**
Un syst√®me d'alertes email professionnel, s√©curis√© et √©volutif, parfaitement int√©gr√© √† l'√©cosyst√®me Dodomove ! üöÄ 